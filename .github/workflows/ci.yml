name: MLOPS CICD - Syntax + Health Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =====================================================
  # 1️⃣ Lint + Health Check
  # =====================================================
  build-and-check:
    runs-on: ubuntu-latest
    env:
      CI_MODE: "1"
      ENV: "ci"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff uvicorn

      - name: Run Ruff lint
        run: |
          ruff check src || echo "⚠️ Ruff found minor lint issues."

      - name: Run Black format check
        run: |
          black --check src || echo "⚠️ Black would reformat some files."

      - name: Start FastAPI app
        run: |
          nohup python -m uvicorn src.api:app --host 0.0.0.0 --port 8000 --log-level info &
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health >/dev/null; then
              echo "✅ API is up"
              break
            fi
            sleep 1
          done

      - name: Run health check
        run: curl -sS http://127.0.0.1:8000/health


  # =====================================================
  # 2️⃣ Pytest + Coverage
  # =====================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build-and-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run pytest with coverage
        run: pytest --cov=src --cov-fail-under=80


  # =====================================================
  # 3️⃣ Build Docker image
  # =====================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: |
          docker build -t mlops-app:${{ github.sha }} .


  # =====================================================
  # 4️⃣ Canary Deploy (simulate in runner)
  # =====================================================
  canary-deploy:
    name: Canary Deploy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Build & Start canary container
        run: |
          docker build -t mlops-app:${{ github.sha }} .
          docker run -d -e CANARY=true -p 8000:8000 mlops-app:${{ github.sha }}
          sleep 10


  # =====================================================
  # 5️⃣ Acceptance Tests
  # =====================================================
  acceptance-tests:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    needs: canary-deploy
    steps:
      - name: Check health endpoint
        run: |
          for i in {1..5}; do
            if curl -f http://127.0.0.1:8000/health; then
              echo "✅ Health check passed"
              exit 0
            fi
            sleep 2
          done
          echo "❌ Health check failed"
          exit 1
