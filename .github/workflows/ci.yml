name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-test-build:
    name: Lint • Test • Build
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install pytest pytest-cov black ruff pip-audit

      - name: Lint (ruff + black)
        run: |
          ruff check src tests
          black --check src tests

      - name: Security audit
        run: pip-audit --ignore-vuln GHSA-h45f-rg32-fxgw || true

      - name: Run tests with coverage
        run: pytest --cov=src --cov-fail-under=80

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push image to GHCR
        run: docker push $IMAGE_NAME

  canary-deploy:
    name: Canary Deploy & Acceptance Tests
    runs-on: ubuntu-latest
    needs: lint-test-build
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}:${{ github.sha }}
    steps:
      - name: Run canary container
        run: |
          docker run -d --name canary -e CANARY=true -p 8080:8000 $IMAGE_NAME
          sleep 10

      - name: Acceptance test (5 golden queries)
        run: |
          for i in {1..5}; do
            curl -s -X GET http://localhost:8080/health || exit 1
          done
          echo "✅ All canary tests passed."

      - name: Stop canary
        run: docker rm -f canary
