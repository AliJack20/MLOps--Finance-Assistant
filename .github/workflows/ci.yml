name: MLOPS CICD - Syntax + Health Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    env:
      CI_MODE: "1"     # üëà ensures dummy model loads (no S3)
      ENV: "ci"

    steps:
      # -------------------------
      # 1Ô∏è‚É£ Get code
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------
      # 2Ô∏è‚É£ Set up Python
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------
      # 3Ô∏è‚É£ Install dependencies
      # -------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff

      # -------------------------
      # 4Ô∏è‚É£ Syntax / Lint check
      # -------------------------
      - name: Run ruff lint
        run: ruff check src

      - name: Run black format check
        run: black --check src

      # -------------------------
      # 5Ô∏è‚É£ Boot API (background)
      # -------------------------
      - name: Start FastAPI app
        run: |
          nohup python -m uvicorn src.api:app --host 0.0.0.0 --port 8000 --log-level info &
          # wait until it‚Äôs up (max 30s)
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8000/health >/dev/null; then
              echo "‚úÖ API is up"
              break
            fi
            sleep 1
          done

      # -------------------------
      # 6Ô∏è‚É£ Health check
      # -------------------------
      - name: Run health check
        run: curl -sS http://127.0.0.1:8000/health
